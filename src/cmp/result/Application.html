<script>    
    import {frameCommunicator,getSrcdoc} from './../../utils/frame_communicator.js';

    import {files} from './../../stores/files.js';
    import {bundler} from './../../stores/bundler.js';
    import {errors} from './../../stores/errors.js';

    let initialized = false;

    let unsubs = [];

    // action for setting up the code dispatcher to the iframe
    function init_iframe({on,dispatch,frame_id}) {
        on('error',e => errors.set(e));
        
        unsubs.push(bundler.subscribe(code => {
            if(bundler.mode.get() === 'application') dispatch('bundle',code);
        }));
    }

    unsubs.push(bundler.initialized.subscribe( state => {
        initialized = state;
    }));       
        
    
    function onDestroy(){
        unsubs.forEach(un => un());
    };
</script>

{#if !initialized}
    <p>Loading Bundler and Malina compiler...</p>
{:else}
    <div class="iframe-wrapper">
        <iframe class="iframe"
            use:frameCommunicator={init_iframe}
            title="Result"
            sandbox="allow-popups-to-escape-sandbox 
                    allow-scripts 
                    allow-popups 
                    allow-forms 
                    allow-pointer-lock 
                    allow-top-navigation 
                    allow-modals 
                    allow-scripts"
            srcdoc={getSrcdoc()}
        ></iframe>
    </div>
{/if}

<style>
    .iframe-wrapper{
        height:100%
    }

	.iframe{
		width: 100%;
        min-height: 100%;
        border: 0;
        margin-bottom: -5px;
	}
</style>
