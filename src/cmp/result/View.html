<script>    
    import {frameCommunicator,getSrcdoc} from './../../utils/frame_communicator.js';

    import {files} from './../../stores/files.js';
    import {bundler} from './../../stores/bundler.js';
    import {errors} from './../../stores/errors.js';

    let load_code_in_frame = ()=>{};
    let initialized = false;

    bundler.initialized.subscribe( state => {
        initialized = state;
    });

    bundler.app.subscribe(code => {
        load_code_in_frame(code);
    });

    // action for setting up the code dispatcher to the iframe
    function frameHandler({on,dispatch}) {
        load_code_in_frame = (bundle) => dispatch('bundle',bundle);
        on('error',e => errors.set(e));
    }

</script>

{#if !initialized}
    <p>Loading Bundler and Malina compiler...</p>
{:else}
    <div class="iframe-wrapper">
        <iframe class="iframe"
            use:frameCommunicator={frameHandler}
            title="Result"
            sandbox="allow-popups-to-escape-sandbox 
                    allow-scripts 
                    allow-popups 
                    allow-forms 
                    allow-pointer-lock 
                    allow-top-navigation 
                    allow-modals 
                    allow-scripts"
            srcdoc={getSrcdoc()}
        ></iframe>
    </div>
{/if}

<style>
    .iframe-wrapper{
        height:100%
    }

	.iframe{
		width: 100%;
        min-height: 100%;
        border: 0;
        margin: 0;
	}
</style>
