<script>
    import {CodeJar} from 'codejar';
    import hljs from 'highlight.js/lib/core.js';
    import xml from 'highlight.js/lib/languages/xml.js';
    import js from 'highlight.js/lib/languages/javascript.js';
    import css from 'highlight.js/lib/languages/css.js';
    import svelte from 'highlightjs-svelte'; // very similar sintax

    import {files} from './../../stores/files.js';

    hljs.registerLanguage('xml', xml);
    hljs.registerLanguage('javascript', js);
    hljs.registerLanguage('css', css);
    svelte(hljs);

    function codeJarAction(node){

        function inputHandler(){
            files.current.save(node.textContent);
        }

        const editor = new CodeJar(node,e => {
           e.innerHTML = hljs.highlight('svelte',e.textContent).value;
        },{tab: ' '.repeat(4)});

        node.addEventListener('input',inputHandler);
        node.style.resize = 'none';

        const unsbcr = files.current.subscribe(file => {
            if(editor.toString() !== file.body) editor.updateCode(file.body);
        });

        return{
            destroy: () => {
                node.removeEventListener('input',inputHandler);
                unsbcr();
            }
        }
    }
</script>

<div :codeJarAction></div>

<style>
    div{
        width: 100%;
        min-height:100%;
        resize: none;
        border: 0;

        font-family: 'Source Code Pro', monospace;
        font-size: 16px;
        font-weight: 400;
        letter-spacing: normal;
        line-height: 20px;
        padding: 10px;
        tab-size: 4;
    }
</style>