<script>    
    import {frameCommunicator,getSrcdoc} from './utils/frame_communicator.js';
    import {bundler,init_bundler} from './utils/bundler.js';

    import {files} from './stores/files.js';

    let load_code_in_frame = ()=>{};
    let loading = true;
    let code = '';

    // initialization and first compile
    (async () => {
        await init_bundler();
        loading = false;
        files.touch();
    })();

    // action for setting up the code dispatcher to the iframe
    function frameHandler({on,dispatch}) {
        load_code_in_frame = (bundle) => dispatch('bundle',bundle);
    }

    async function bundle_sources(sources){
        const code = await bundler(sources);
        load_code_in_frame(code);
    }

    // compile sources with cooldown timeout
    let cooldown = false;
    let wasChanged = false;

    files.subscribe(sources => {
        if(loading) return;
        
        if(cooldown) return wasChanged = true;

        bundle_sources(sources);
        cooldown = setTimeout(()=>{
            if(wasChanged) bundle_sources(sources);
            cooldown = false;
        },500);

    });

</script>

{#if loading}
    <p>Loading Bundler and Malina compiler...</p>
{:else}

	<iframe
        use:frameCommunicator={frameHandler}
        title="Result"
        sandbox="allow-popups-to-escape-sandbox allow-scripts allow-popups 
                            allow-forms allow-pointer-lock allow-top-navigation allow-modals allow-scripts"
        srcdoc={getSrcdoc()}
	></iframe>
{/if}

<style>
	iframe{
		width: 100%;
		height: 100%;
        border: 0
	}
</style>
