<script>    
    import {frameCommunicator,getSrcdoc} from './utils/frame_communicator.js';
    import {bundler,init_bundler} from './utils/bundler.js';

    export let files;
    
    let load_code_in_frame = ()=>{};
    let loading = true;

    // initialization and first compile
    (async () => {
        await init_bundler();
        loading = false;
        bundle_with_cooldown();
    })();

    // action for setting up the code dispatcher to the iframe
    function frameHandler({on,dispatch}) {
        load_code_in_frame = (bundle) => dispatch('bundle',bundle);
    }

    async function bundle_files(){
        const bundle = await bundler(files);
        load_code_in_frame(bundle);
    }
        
    // compile sources with cooldown timeout
    let cooldown = 0;
    let wasChanged = false;
    async function bundle_with_cooldown(){
        if(cooldown) return wasChanged = true;

        await bundle_files();
        cooldown = setTimeout(async ()=>{
            if(wasChanged) await bundle_files();
            cooldown = 0;
            wasChanged = false;
        },500);
    }    

    $: loading,files,()=>bundle_with_cooldown();
</script>

{#if loading}
    <p>Loading Bundler and Malina compiler...</p>
{:else}

	<iframe
        use:frameCommunicator={frameHandler}
        title="Result"
        sandbox="allow-popups-to-escape-sandbox allow-scripts allow-popups 
                            allow-forms allow-pointer-lock allow-top-navigation allow-modals allow-scripts"
        srcdoc={getSrcdoc()}
	></iframe>
{/if}

<style>
	iframe{
		width: 100%;
		height: 100%;
        border: 0
	}
</style>
