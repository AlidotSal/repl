(()=>{function h(e){e=e||self;let n=[],o=(s,l)=>{n.push({event:s,handler:l})},r=(s,l)=>{n.filter(d=>d.event!==s&&d.handler!==l)},t=(s,l)=>{e.postMessage({event:s,details:l})};return e.addEventListener("message",({data:s})=>{n.filter(l=>l.event===s.event).forEach(l=>l.handler(s.details))}),{on:o,off:r,emit:t}}var i="modules",w="https://unpkg.com";var x=["rollup","acorn","astring","csstree","cjs2es"];function g(e){return self[e]!==void 0}function c(e){if(!g(e))throw new Error(`[REPL]: Dependency not initialized: ${e}`)}function y(){for(let e of x)importScripts(`${i}/${e}.js`),c(e);self["css-tree"]=self.csstree}function p(e){if(e=e||"latest",g("malina")){if(malina.version===e)return;delete self.malina}try{importScripts(`${i}/malinajs/${e}/malina.js`)}catch(n){throw new Error(`[REPL]: Can't load MalinaJS v.${e}`)}c("malina")}async function u(e,n,o){c("malina");let r={exportDefault:!0,inlineTemplate:!0,autoSubscribe:!0,name:n,localConfig:!1,injectRuntime:o?null:"$runtime.configure({onerror: (e) => {window.malina_onerror && malina_onerror(e)}})"};try{let t=await malina.compile(e,r);return t.result&&(t=t.result),o?await j(t):t}catch(t){throw console.error(t),new Error(`[MalinaJS] Compile error: ${t.message}: ${t.details}`)}}async function j(e){c("rollup");let o=(await(await rollup.rollup({input:"./app.js",external:()=>!0,plugins:[{name:"plugin",async resolveId(r){return r},async load(r){return r==="./app.js"?e:""}}],onwarn:()=>{}})).generate({format:"es"})).output[0].code;return b(o)}function b(e){e=e.replace(/ import\(/g," import_dynamic("),console.log(e);let n=acorn.parse(e,{sourceType:"module"});return e=astring.generate(n),e=e.replace(/ import_dynamic\(/g," import("),e}async function E(e){try{return c("rollup"),(await(await rollup.rollup({input:"./App.xht",external:!1,inlineDynamicImports:!0,treeshake:!1,plugins:[v(),D(e),R(),S()]})).generate({format:"iife",name:"Component",exports:"named",sourcemap:!1})).output[0].code}catch(n){throw n}}function v(){let e=/^\.{1,2}\//,n=/^https?:\/\/|^\/\//,o=/^malinajs\//;return{name:"rollup_plugin_module_resolver",async resolveId(r,t){return e.test(r)&&(!t||e.test(t))?r:e.test(r)&&n.test(t)?new URL(r,k(t)).href:r=="malinajs"?`${i}/malinajs/${malina?malina.version:"latest"}/runtime.js`:o.test(r)?`${i}/malinajs/${malina?malina.version:"latest"}/${r.slice(9)}`:await M(`${w}/${r}`)}}}function D(e){return{name:"rollup_plugin_files",async load(n){if(!n.startsWith("./"))return null;n=n.replace(/^\.\//,"");let o=e.find(r=>r.name===n);if(o===void 0)throw new Error(`[Bundler]: File ./${n} does not exist.`);return o.body}}}function R(){return{name:"rollup_plugin_download",async load(e){if(!/^https?:\/\//.test(e)&&!e.startsWith(`${i}/malinajs`))return null;try{let n=await _(e);return cjs2es.cjs2es(n.body)}catch(n){throw new Error(`[Bundler]: Unable download file ${e}.`)}}}}function S(){return{name:"rollup_plugin_malina",async transform(e,n){let o=n.match(/([^/]+).(html|ma|xht)$/);return o?{code:await u(e,o[1])}:null}}}function k(e){return e.slice(-1)==="/"||/\.[a-z0-9]+$/.test(e)?e:e+"/"}async function M(e){try{let n=await _(e);if(!n.ok)throw new Error(`Can't find module ${e}`);return e=n.url,e}catch(n){throw new Error(`[Bundler] ${n.message}`)}}var f={};async function _(e){if(!f[e]){let n=await fetch(e);if(!n.ok)throw new Error(`[Bundler] Can't download module from ${e}`);f[e]={url:n.url,ok:n.ok,status:n.status,body:n.ok?await n.text():""}}return f[e]}var{on:m,emit:a}=h(),$=!1;try{m("init",e=>{a("init"),$=!1,y(),p(e&&e.malinaVersion||"latest"),$=!0,a("ready",{malinaVersion:malina.version,rollupVersion:rollup.VERSION}),a("malinaVersion",malina.version)}),m("bundle",async e=>{try{let n=await E(e);a("bundle",n)}catch(n){console.error(n),a("error",n.message),a("bundle","")}}),m("compile",async e=>{try{let n=await u(e.code,e.name,!0);n.result&&(n=n.result),a("compile",n)}catch(n){console.error(n),a("error",n.message),a("compile","")}}),m("malinaVersion",async e=>{p(e),a("ready",{malinaVersion:malina.version,rollupVersion:rollup.VERSION})})}catch(e){console.error(e),a("error",e.message)}})();
