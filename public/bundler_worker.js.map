{
  "version": 3,
  "sources": ["../src/lib/messages.js", "../src/config.js", "../src/bundler/deps.js", "../src/bundler/compiler.js", "../src/bundler/bundler.js", "../src/bundler/worker.js"],
  "sourcesContent": ["export function getMessageEventsFunctions(target){\n\n    target = target || self;\n    \n    const listeners = [];\n\n    const on = (event,handler) => {\n        listeners.push({event,handler});\n    }\n\n    const off = (event,handler) => {\n        listeners.filter( l => l.event !== event && l.handler !== handler);\n    }\n\n    const emit = (event,data) => {\n        target.postMessage({event,details:data});\n    }\n\n    target.addEventListener(\"message\", ({data}) => {\n        listeners.filter(l => l.event === data.event).forEach(l => l.handler(data.details));\n    });\n\n    return {on,off,emit}\n}", "export const DEPS_REPO = 'modules';\nexport const MODULES_REPO = 'https://unpkg.com';", "import {DEPS_REPO} from './../config';\n\nconst DEPS = ['rollup','acorn','astring','csstree','cjs2es'];\n\nexport function isLoaded(dep){\n    return self[dep] !== undefined;\n}\n\nexport function checkDependency(dep){\n    if(!isLoaded(dep)) throw new Error(`[REPL]: Dependency not initialized: ${dep}`);\n}\n\nexport function checkDependencies(){\n    for( let dep of DEPS ){\n        checkDependency(dep);\n    }\n}\n\nexport function loadDependencies(){\n    for( let dep of DEPS ){\n        importScripts(`${DEPS_REPO}/${dep}.js`);\n        checkDependency(dep);\n    }\n    self['css-tree'] = self['csstree'];\n}\n\nexport function loadMalina(ver){\n    ver = ver || 'latest';\n\n    if(isLoaded('malina')){\n        if(malina.version === ver) return;\n        delete self['malina'];\n    }\n    \n    try {\n        importScripts(`${DEPS_REPO}/malinajs/${ver}/malina.js`);\n    } catch (e) {\n        throw new Error(`[REPL]: Can't load MalinaJS v.${ver}`);\n    }\n\n    checkDependency('malina');\n}\n\nlet verCash;\nexport async function getMalinaVersions(){\n    if(!verCash){\n        try{\n            const resp = await fetch(`${DEPS_REPO}/malinajs/versions.json`);\n            verCash = resp.ok ? await reap.json() : [];\n        }catch(e){\n            console.error(e);\n            verCash = [];\n        }\n    }\n    return verCash;\n}", "import {checkDependency} from './deps';\n\nexport async function compile(code,name,treeshaked){\n\n    checkDependency('malina');\n\n    let opts = {\n        exportDefault: true,\n        inlineTemplate: true,\n        autoSubscribe: true,\n        name,\n        localConfig: false,\n        injectRuntime: treeshaked ? null : '$runtime.configure({onerror: (e) => {window.malina_onerror && malina_onerror(e)}})'\n    }\n    \n    try {\n        let result =  await malina.compile(code, opts);\n        if(result.result) result = result.result;\n        return treeshaked ? await treeshake(result) : result;\n    } catch (e) {\n        console.error(e);\n        throw new Error(`[MalinaJS] Compile error: ${e.message}: ${e.details}`);\n    }\n}\n\nasync function treeshake(code){\n    checkDependency('rollup');\n    let bundle = await rollup.rollup({\n        input: \"./app.js\",\n        external: ()=>true,\n        plugins: [{\n            name: 'plugin',\n            async resolveId(id) {return id},\n            async load(id) {return id === './app.js' ? code : ''}\n        }],\n        onwarn: ()=>{}\n    });\n    const result = (await bundle.generate({format: \"es\"})).output[0].code;\n    return pretify(result);\n}\n\nfunction pretify(code){\n    //TODO remove fix when https://github.com/davidbonnet/astring/issues/335 will be resolved\n    //FIX dynamic import in astring\n    code = code.replace(/ import\\(/g,' import_dynamic(');\n\n    console.log(code);\n    let ast = acorn.parse(code, {sourceType: 'module'});\n    code =  astring.generate(ast);\n    \n    //FIX dynamic import in astring\n    code = code.replace(/ import_dynamic\\(/g,' import(');\n\n    return code;\n}", "import {checkDependency} from './deps';\nimport {compile} from './compiler';\nimport {DEPS_REPO, MODULES_REPO} from './../config';\n\nexport async function bundle(files){\n    \n    try {\n        checkDependency('rollup');\n\n        let bundle = await rollup.rollup({\n            input: \"./App.xht\",\n            external: false,\n            inlineDynamicImports: true,\n            treeshake: false,\n            plugins: [\n                module_resolver_plugin(),\n                component_plugin(files),\n                download_plugin(),\n                malina_plugin()\n            ]\n        });\n\n        return (await bundle.generate({\n            format: \"iife\",\n            name: \"Component\",\n            exports: \"named\",\n            sourcemap: false\n        })).output[0].code;\n\n    } catch (err) {\n        throw err;\n    }\n\n}\n\n// ---- Rollup plugins ---- //\n\n// Module path resolver\nfunction module_resolver_plugin(){\n    const localRg = /^\\.{1,2}\\//;\n    const netRg = /^https?:\\/\\/|^\\/\\//;\n    const malinaRg = /^malinajs\\//;\n    return {\n        name: 'rollup_plugin_module_resolver',\n        async resolveId(id, importer){\n            // Local file\n            if(localRg.test(id) && (!importer || localRg.test(importer)) ) return id;\n\n            // Local on UNPKG\n\n            if(localRg.test(id) && netRg.test(importer)) return new URL(id,addSlash(importer)).href;\n\n            // MalinaJS Libs\n            if(id == 'malinajs') return `${DEPS_REPO}/malinajs/${malina ? malina.version : 'latest'}/runtime.js`;\n            if(malinaRg.test(id)) return `${DEPS_REPO}/malinajs/${malina ? malina.version : 'latest'}/${id.slice(9)}`;\n            \n            // From UNPKG\n            return await getModuleURL(`${MODULES_REPO}/${id}`);\n        }\n    }\n}\n\n// Get source from user's components\nfunction component_plugin(files) {\n    \n    return {\n        name: 'rollup_plugin_files',\n        async load(id) { \n            if(!id.startsWith('./')) return null;\n            id = id.replace(/^\\.\\//,'');\n            const file = files.find(f=>f.name===id);\n            if(file === undefined) throw new Error(`[Bundler]: File ./${id} does not exist.`);\n            return file.body;\n        }\n    }\n}\n\n\n// Download module's source from repository\nfunction download_plugin() {\n    return {\n        name: 'rollup_plugin_download',\n\n        async load(id) { \n            \n            if(!/^https?:\\/\\//.test(id) && !id.startsWith(`${DEPS_REPO}/malinajs`)) return null;\n\n            try {\n                const result = await cash_or_fetch(id);\n                return cjs2es.cjs2es(result.body);\n            } catch (err) {\n                throw new Error(`[Bundler]: Unable download file ${id}.`);\n            }\n        }\n    }\n}\n\n\n// Compiling Malina's components\nfunction malina_plugin() {\n    return {\n        name: 'rollup_plugin_malina',\n\n        async transform(code, id) {\n            const name = id.match(/([^/]+).(html|ma|xht)$/);\n            if(!name) return null;\n            return {code: await compile(code,name[1])};\n        }\n    }\n}\n\n\n// ---- Helpers ---- //\n\nfunction addSlash(url){\n    if(url.slice(-1) === '/') return url;\n    if(/\\.[a-z0-9]+$/.test(url)) return url;\n    return url+'/';\n}\n\nasync function getModuleURL(url){\n    try{\n        // try to find package real URL\n        let result = await cash_or_fetch(url);\n        if(!result.ok)  throw new Error(`Can't find module ${url}`);\n        url = result.url;\n        return url;\n    }catch(err){\n        throw new Error(`[Bundler] ${err.message}`);\n    }\n}\n\nconst FCASH = {};\nasync function cash_or_fetch(url){\n    if(!FCASH[url]) {\n        const resp = await fetch(url);\n        if(!resp.ok) throw new Error(`[Bundler] Can't download module from ${url}`);\n        FCASH[url] = {url: resp.url, ok: resp.ok, status:resp.status, body: resp.ok ? await resp.text() : ''}\n    }\n    return FCASH[url];\n}", "import {getMessageEventsFunctions} from './../lib/messages';\nimport {loadDependencies,loadMalina} from './deps';\nimport {compile} from './compiler';\nimport {bundle} from './bundler';\n\nconst {on,emit} = getMessageEventsFunctions();\n\nlet initialized = false;\n\ntry{\n    on(\"init\", data => {\n        emit('init');\n\n        initialized = false;\n        loadDependencies();\n        loadMalina(data && data.malinaVersion || 'latest');\n        initialized = true;\n\n        emit('ready',{\n            malinaVersion: malina.version,\n            rollupVersion: rollup.VERSION,\n        });\n\n        emit('malinaVersion',malina.version);\n    });\n\n    on('bundle', async files => {\n        try{\n            const result = await bundle(files);\n            emit('bundle',result);\n        }catch(err){\n            console.error(err);\n            emit('error',err.message);\n            emit('bundle','');\n        }\n    });\n\n    on('compile', async data => {\n        try{\n            let result =  await compile(data.code,data.name,true);\n            if(result.result) result = result.result;\n            emit('compile',result);\n        }catch(err){\n            console.error(err);\n            emit('error',err.message);\n            emit('compile','');\n        }\n    });\n    \n    on('malinaVersion', async version => {\n        loadMalina( version);\n        emit('ready',{\n            malinaVersion: malina.version,\n            rollupVersion: rollup.VERSION,\n        });\n    });\n}catch(err){\n    console.error(err);\n    emit('error',err.message)\n}\n\n"],
  "mappings": "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",
  "names": []
}
